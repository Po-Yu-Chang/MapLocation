# FaceAiSharp 人臉辨識系統流程圖

## 1. 整體系統架構流程圖

```mermaid
graph TB
    A[用戶開啟人臉辨識 Tab] --> B[初始化相機服務]
    B --> C[檢測可用相機設備]
    C --> D[顯示相機選擇介面]
    D --> E[用戶選擇相機]
    E --> F[啟動相機預覽]
    F --> G[即時人臉偵測]
    
    G --> H{偵測到人臉？}
    H -->|是| I[顯示人臉框]
    H -->|否| G
    
    I --> J{已知人臉？}
    J -->|是| K[顯示姓名標籤]
    J -->|否| L[顯示 '未知' 標籤]
    
    K --> M[繼續監控]
    L --> M
    M --> G
    
    I --> N[用戶點擊儲存人臉]
    N --> O[彈出命名對話框]
    O --> P[輸入姓名確認]
    P --> Q[儲存人臉編碼到資料庫]
    Q --> R[顯示儲存成功]
    R --> G
```

## 2. FaceAiSharp 人臉處理流程

```mermaid
graph TB
    A[相機捕獲影像] --> B[ImageSharp 影像轉換]
    B --> C[FaceAiSharp 人臉偵測]
    C --> D{是否偵測到人臉？}
    
    D -->|否| E[返回空結果]
    D -->|是| F[ArcFace 特徵提取]
    F --> G[ONNX 模型推理]
    G --> H[特徵向量比對]
    
    H --> I{找到匹配？}
    I -->|是| J[返回姓名和信心度]
    I -->|否| K[標記為未知人臉]
    
    J --> L[繪製人臉框和標籤]
    K --> M[繪製未知人臉框]
    
    L --> N[更新 UI]
    M --> N
    E --> N
```

## 3. 相機設備管理流程

```mermaid
graph TB
    A[啟動應用程式] --> B[掃描可用相機]
    B --> C[建立相機設備列表]
    
    C --> D{是手機平台？}
    D -->|是| E[偵測前/後鏡頭]
    D -->|否| F[偵測外部相機]
    
    E --> G[前鏡頭可用？]
    F --> H[USB/內建鏡頭可用？]
    
    G -->|是| I[加入前鏡頭到列表]
    G -->|否| J[跳過前鏡頭]
    
    I --> K[後鏡頭可用？]
    J --> K
    K -->|是| L[加入後鏡頭到列表]
    K -->|否| M[顯示相機選擇 UI]
    
    H -->|是| N[加入外部相機到列表]
    H -->|否| O[顯示無相機錯誤]
    
    L --> M
    N --> M
    
    M --> P[用戶選擇相機]
    P --> Q[啟動選定相機]
    Q --> R[開始預覽]
```

## 4. 資料儲存與管理流程

```mermaid
graph TB
    A[儲存人臉請求] --> B[驗證姓名格式]
    B --> C{姓名有效？}
    C -->|否| D[顯示錯誤訊息]
    C -->|是| E[檢查重複姓名]
    
    E --> F{姓名已存在？}
    F -->|是| G[詢問是否覆蓋]
    F -->|否| H[生成人臉編碼]
    
    G --> I{用戶確認覆蓋？}
    I -->|否| J[取消操作]
    I -->|是| H
    
    H --> K[加密人臉資料]
    K --> L[儲存到 SQLite]
    L --> M{儲存成功？}
    
    M -->|是| N[更新 UI 列表]
    M -->|否| O[顯示儲存失敗]
    
    N --> P[顯示成功訊息]
    
    D --> Q[等待用戶重新輸入]
    J --> Q
    O --> Q
    P --> R[結束流程]
    Q --> R
```

## 5. FaceAiSharp 服務初始化流程

```mermaid
graph TB
    A[應用程式啟動] --> B[檢測執行平台]
    
    B --> C{平台類型？}
    C -->|Windows| D[初始化 FaceAiSharp.Bundle]
    C -->|macOS| E[初始化 FaceAiSharp.Bundle]
    C -->|Android| F[嘗試 FaceAiSharp 或降級 ML Kit]
    C -->|iOS| G[嘗試 FaceAiSharp 或降級 Vision]
    
    D --> H[載入 ONNX Runtime 與預訓練模型]
    E --> I[載入 ONNX Runtime 與預訓練模型]
    F --> J[檢查 FaceAiSharp 相容性]
    G --> K[檢查 FaceAiSharp 相容性]
    
    H --> L{初始化成功？}
    I --> L
    J --> M{FaceAiSharp 可用？}
    K --> M
    
    M -->|是| L
    M -->|否| N[初始化備用方案]
    
    L -->|是| O[註冊 FaceAiSharp 服務]
    L -->|否| P[顯示錯誤訊息]
    N --> Q[註冊備用服務]
    
    O --> R[啟動完整功能 UI]
    P --> S[顯示錯誤訊息]
    Q --> T[啟動受限功能 UI]
    
    R --> U[系統就緒 - FaceAiSharp 模式]
    S --> V[系統就緒 - 錯誤模式]
    T --> W[系統就緒 - 備用模式]
```

## 6. 錯誤處理流程

```mermaid
graph TB
    A[操作開始] --> B[執行功能]
    B --> C{是否發生錯誤？}
    
    C -->|否| D[正常完成]
    C -->|是| E{錯誤類型？}
    
    E -->|相機存取錯誤| F[檢查權限]
    E -->|網路錯誤| G[檢查網路連線]
    E -->|記憶體不足| H[清理記憶體]
    E -->|平台不支援| I[顯示替代方案]
    E -->|其他錯誤| J[記錄錯誤日誌]
    
    F --> K{權限已授予？}
    K -->|是| L[重新嘗試相機存取]
    K -->|否| M[引導用戶授予權限]
    
    G --> N{網路已恢復？}
    N -->|是| O[重新嘗試網路操作]
    N -->|否| P[使用離線模式]
    
    H --> Q[重新嘗試操作]
    I --> R[提供降級功能]
    J --> S[顯示通用錯誤訊息]
    
    L --> T[繼續正常流程]
    M --> U[等待用戶操作]
    O --> T
    P --> V[在離線模式繼續]
    Q --> B
    R --> W[以受限功能運行]
    S --> X[等待用戶重試]
    
    T --> D
    U --> Y[流程結束]
    V --> D
    W --> D
    X --> Y
    D --> Y
```

## 7. 用戶互動流程

```mermaid
graph TB
    A[用戶開啟人臉辨識頁面] --> B[載入相機預覽]
    B --> C[顯示控制按鈕]
    
    C --> D{用戶操作？}
    D -->|切換相機| E[顯示相機選擇清單]
    D -->|拍照| F[捕獲當前畫面]
    D -->|儲存人臉| G[開啟命名對話框]
    D -->|設定| H[開啟設定選單]
    D -->|查看已儲存人臉| I[開啟人臉管理頁面]
    
    E --> J[用戶選擇新相機]
    J --> K[切換到選定相機]
    K --> C
    
    F --> L[顯示拍攝結果]
    L --> M[詢問是否儲存]
    M --> N{用戶確認？}
    N -->|是| G
    N -->|否| C
    
    G --> O[輸入人臉名稱]
    O --> P[驗證並儲存]
    P --> Q[顯示儲存結果]
    Q --> C
    
    H --> R[調整設定選項]
    R --> S[儲存設定]
    S --> C
    
    I --> T[顯示已儲存人臉清單]
    T --> U{用戶選擇操作？}
    U -->|編輯| V[修改人臉名稱]
    U -->|刪除| W[確認刪除操作]
    U -->|返回| C
    
    V --> X[儲存修改]
    X --> T
    W --> Y[執行刪除]
    Y --> T
```

## 8. 記憶體管理流程

```mermaid
graph TB
    A[開始處理影像] --> B[分配記憶體緩衝區]
    B --> C[載入影像資料]
    C --> D[執行人臉偵測]
    D --> E[處理偵測結果]
    
    E --> F[釋放影像緩衝區]
    F --> G{記憶體使用量檢查}
    G -->|正常| H[繼續下一幀]
    G -->|過高| I[強制垃圾回收]
    
    I --> J[清理暫存資料]
    J --> K[等待記憶體釋放]
    K --> L{記憶體已釋放？}
    L -->|是| H
    L -->|否| M[降低處理品質]
    
    M --> N[調整處理參數]
    N --> H
    H --> O[繼續監控循環]
    
    O --> P{應用程式結束？}
    P -->|否| A
    P -->|是| Q[清理所有資源]
    Q --> R[結束應用程式]
```

## 系統流程說明

### 核心流程特點：

1. **非同步處理**: 所有相機操作和人臉辨識處理都在背景執行緒進行
2. **錯誤恢復**: 每個主要操作都有對應的錯誤處理機制
3. **記憶體優化**: 實時監控記憶體使用，適時釋放資源
4. **平台適應**: 根據不同平台選擇最佳的技術實作
5. **用戶體驗**: 提供即時反饋和直覺的操作介面

### FaceAiSharp 關鍵決策點：

- **技術統一**: FaceAiSharp 提供統一的 API，簡化跨功能開發
- **ONNX 優化**: 利用 ONNX Runtime 實現最佳硬體加速
- **模型管理**: Bundle 套件簡化模型部署與版本控制
- **平台適配**: 優先桌面平台，移動平台採用備用策略
- **效能分層**: 根據平台能力選擇不同精度的模型配置

## 9. FaceAiSharp 特有優化流程

```mermaid
graph TB
    A[啟動 FaceAiSharp 服務] --> B[檢測硬體能力]
    B --> C{GPU 可用？}
    
    C -->|是| D[啟用 ONNX GPU Provider]
    C -->|否| E[使用 CPU Provider]
    
    D --> F[載入高精度模型]
    E --> G[載入平衡模型]
    
    F --> H[設定 GPU 記憶體限制]
    G --> I[設定 CPU 線程數]
    
    H --> J[初始化 ImageSharp 管線]
    I --> J
    
    J --> K[預熱模型推理]
    K --> L[快取常用轉換]
    L --> M[服務就緒]
    
    M --> N[持續效能監控]
    N --> O{效能下降？}
    O -->|是| P[調整模型精度]
    O -->|否| Q[維持當前設定]
    
    P --> R[通知用戶設定變更]
    Q --> N
    R --> N
```

這個 FaceAiSharp 為中心的流程圖架構展現了現代化人臉辨識系統的完整生命週期，從初始化到動態優化，確保在不同平台上都能提供最佳的用戶體驗和技術效能。